#!/usr/bin/env sh
# mvnw-artifact: fetch AWS CodeArtifact token, then delegate to ./mvnw

[ -f ".mvn/codeartifact.env" ] && . ".mvn/codeartifact.env"

if [ -z "${CODEARTIFACT_AUTH_TOKEN:-}" ]; then
  if command -v aws >/dev/null 2>&1 &&
     [ -n "${CA_DOMAIN:-}" ] && [ -n "${CA_DOMAIN_OWNER:-}" ] && [ -n "${CA_REGION:-}" ]; then
    CA_DURATION_SECONDS="${CA_DURATION_SECONDS:-43200}"
    CODEARTIFACT_AUTH_TOKEN="$(
      aws codeartifact get-authorization-token \
        --domain "$CA_DOMAIN" \
        --domain-owner "$CA_DOMAIN_OWNER" \
        --region "$CA_REGION" \
        --duration-seconds "$CA_DURATION_SECONDS" \
        --query authorizationToken --output text 2>/dev/null || true
    )"
    export CODEARTIFACT_AUTH_TOKEN
  fi
fi

exec "$(dirname "$0")/mvnw" "$@"